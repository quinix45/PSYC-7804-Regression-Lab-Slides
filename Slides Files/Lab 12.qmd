---
title: "Lab 12: Mediation Analysis"
author: "Fabio Setti"
institute: "PSYC 7804 - Regression with Lab"
bibliography: Additional files/R packages.bib
csl: Additional files/apa.csl
title-slide-attributes:
  data-transition: "zoom"
  data-visibility: "uncounted"
format:
   revealjs:
      footer: "Lab 12: Mediation Analysis"
      width: 1280
      height: 720
      chalkboard: true
      slide-number: c/t 
      theme: Fabio_theme/Fabio_theme.scss
      navigation-mode: linear
      controls: false
      auto-stretch: false
      header-includes:
        - <script src="Fabio_theme/Fabio_theme.js"></script>

editor: source
---


<!-- https://stats.oarc.ucla.edu/other/mult-pkg/seminars/spss-process/ -->

## Today's Packages and Data ðŸ¤—

:::: {.columns}
::: {.column width="50%"}

```{r}
#| code-fold: true
#| eval: false
#| echo: true
#| code-line-numbers: false
#| code-summary: "Install Packages Code"
#| classes: code-150

# install.packages("tidyverse")
install.packages("lavaan")
```

```{r}
#| eval: true
#| echo: true
#| code-line-numbers: false
#| warning: false
#| classes: code-150

library(tidyverse)
theme_set(theme_classic(base_size = 14, 
                        base_family = 'serif'))
library(lavaan)
```


</br>

<div style="font-size: 26px">

::: {.panel-tabset}
### `lavaan`

<div style="font-size: 22px"> The `lavaan` package [@Rosseel_etal_2024a] is the most popular package to run SEM  models in R. We will use it to run mediation analysis, which the SEM framework accommodates. </div>

:::

</div>

  

:::


::: {.column width="50%"}

<center style="padding-bottom: 41px;"> [Data]{.data-title} </center>

 
```{r}
#| warning: false
#| classes: code-125
#| echo: true
#| code-line-numbers: false
#| output: true

dat <- rio::import("https://github.com/quinix45/PSYC-7804-Regression-Lab-Slides/raw/refs/heads/main/Slides%20Files/Data/mediation_dat.csv")

```


<center style="padding-bottom: 11px;"> </center>

```{r}
reactable::reactable(dat,
                     style = list(fontFamily = "Work Sans, sans-serif", fontSize = "1.105rem"),
                     pagination = FALSE, highlight = TRUE, height = 300)
```

:::
::::

## Why `lavaan` for Mediation?

Before we begin, I would be remiss not to mention other packages for running mediation:

:::: {.columns}
::: {.column width="50%"}

<ul style="font-size: 22px">  

<li> The `PROCESS` macro:  [PROCESS](https://www.processmacro.org/index.html){target="_blank"} is a macro for SPSS, SAS, and R that runs mediation and moderation analysis. There is no package for it, so you need to run all the functions before using it. Aside from that, I find it to be less flexible than `lavaan` for specifying different models, as well as the online help and documentation being almost non-existent. </li>

</ul>




:::
::: {.column width="50%"}

<ul style="font-size: 22px">  

<li> The `mediation` package [@Tingley_etal_2019]: This package implements the *causal mediation framework* described in @Imai_etal_2010a. It is a very flexible package, and it accommodated both multilevel mediation and non-linear mediation. @Tingley_etal_2014 describe many of the `mediation` package functionalities in detail. The one "problem" is that it is not very easy to specify multiple mediators and moderators. </li>

</ul>

:::
::::

</br>

`lavaan` is a package for [structural equation modeling](https://en.wikipedia.org/wiki/Structural_equation_modeling){target="_blank"} (SEM). SEM is a general framework that aims to explain how the observe correlation matrix among a set of variable arises by essentially running many regressions. 

As we will see, mediation is nothing but two or more regression models. You certainly *do not need* SEM turn run mediation; however, `lavaan` makes it quite straightforward.


## More on today's data


Today's data is adapted from the examples shown [here](https://stats.oarc.ucla.edu/other/mult-pkg/seminars/spss-process/){target="_blank"}. The data comes from a fiction study were participants 

:::: {.columns}
::: {.column width="50%"}

<ul style="font-size: 22px">  

<li>  `gender`: Binary variable indicating participant's gender (0 = male, 1 = female). </li>

<li>  `detail`: How much information participants were given regarding the event. ($X$) </li>

<li>  `feeling`: beliefs about the topic after hearing details. ($M_1$)  </li>

<li>  `impact`: How impactful participants believed the details were.($M_2$) </li>

<li>  `opinion`: How strongly participants opposed a law cutting. ($Y$) </li>

</ul>


:::
::: {.column width="50%"}

```{r}
reactable::reactable(dat,
                     style = list(fontFamily = "Work Sans, sans-serif", fontSize = "1.105rem"),
                     pagination = FALSE, highlight = TRUE, height = 300)
```


:::
::::


## Running a regresison in `lavaan`

Because of its flexibility, `lavaan`'s model require a specific syntax. 

:::: {.columns}
::: {.column width="50%"}

```{r}
#| eval: true
#| echo: true 
#| code-line-numbers: false
#| classes: code-125

reg_lm <- lm(opinion ~ detail, dat)

car::S(reg_lm)
```


:::
::: {.column width="50%"}




:::
::::




```{r include=FALSE}
# mod <- "feeling ~ detail
#         feeling ~ 1 "
# 
# res <- sem(mod, data = dat, fixed)
# 
# 
# parameterEstimates(res) 
```

```{r include=FALSE}
summary(lm(opinion ~ detail, dat))
```



```{r include=FALSE}
#causal chain to be emphasized

summary(lm(opinion ~ detail + feeling , dat))

## the effect of X is weaker once feeling (M_1) is included in the model. This 

```
```{r include=FALSE}
reg <- lm(opinion ~ impact + detail + feeling , dat)



```


## Running Mediation





## Prova 

```{tikz}
#| fig-ext: svg
#| fig-width: 5

\usetikzlibrary{arrows,intersections}
  \begin{tikzpicture}
    \node (X) at (0,0) [draw, rectangle] {X};
    \node (M) at (2,.8) [draw, rectangle] {M};
    \node (Y) at (4,0) [draw, rectangle] {Y};
    
    % Arrows
    \draw[-stealth] (X) -- (M) node[midway, above] {a};
    \draw[-stealth] (M) -- (Y) node[midway, above] {b};
    \draw[-stealth] (X) -- (Y) node[midway, above] {c'};
  
  \end{tikzpicture}
```

## References 



<div id="refs"> </div>

